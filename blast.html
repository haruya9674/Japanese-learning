<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Blast Puzzle</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:system-ui,sans-serif;
  background:linear-gradient(180deg,#fff1f8,#e8f8ff);
  text-align:center;
  padding:10px;
}
a{ text-decoration:none;color:#333; }

.topbar{
  display:flex;
  justify-content:space-between;
  max-width:360px;
  margin:0 auto 6px;
}

.panel{
  background:#fff;
  padding:6px 10px;
  border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,.2);
  font-size:14px;
}

.grid{
  display:grid;
  gap:6px;
  margin:10px auto;
}

.cell{
  width:40px;
  height:40px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  cursor:pointer;
  transition:transform .2s,opacity .4s;
}
.cell.fade{
  opacity:0;
  transform:scale(0.4);
}

.red{background:#ff7675;}
.blue{background:#74b9ff;}
.yellow{background:#ffeaa7;}
.green{background:#55efc4;}
.purple{background:#a29bfe;}

.rocket{background:#fd79a8;}
.bomb{background:#2d3436;color:white;}

button{
  padding:6px 12px;
  border-radius:12px;
  border:none;
  margin:6px;
}
</style>
</head>

<body>

<a href="index.html">‚Üê Back to Menu</a>
<h3 id="stage"></h3>

<div class="topbar">
  <div class="panel" id="moves"></div>
  <div class="panel" id="goal"></div>
</div>

<div id="grid" class="grid"></div>

<div class="panel" id="score"></div>

<div>
  <input id="nameInput" placeholder="„Å™„Åæ„Åà / name" maxlength="10">
  <button onclick="sendScore()">Send Score</button>
</div>

<div class="panel">
  <h4>üèÜ Ranking</h4>
  <ol id="ranking"></ol>
</div>

<script>
/* ========= Âü∫Êú¨Ë®≠ÂÆö ========= */
const COLORS=["red","blue","yellow","green","purple"];
let stage = Number(localStorage.getItem("blastStage")) || 1;
let board=[],ROWS,COLS,movesLeft,goal,score=0;

/* ========= „Çπ„ÉÜ„Éº„Ç∏ÁîüÊàê ========= */
function stageData(n){
  return {
    rows:6+Math.min(4,Math.floor(n/10)),
    cols:6+Math.min(4,Math.floor(n/10)),
    colors:Math.min(5,3+Math.floor(n/20)),
    moves:18+Math.floor(n/3),
    goal:{ red:8+n, blue:8+n }
  };
}

function randColor(limit){
  return COLORS[Math.floor(Math.random()*limit)];
}

/* ========= ÂàùÊúüÂåñ ========= */
function init(){
  const s=stageData(stage);
  ROWS=s.rows; COLS=s.cols;
  movesLeft=s.moves;
  goal=JSON.parse(JSON.stringify(s.goal));

  board=[];
  for(let r=0;r<ROWS;r++){
    board[r]=[];
    for(let c=0;c<COLS;c++){
      board[r][c]={type:"color",value:randColor(s.colors)};
    }
  }
  draw();
  updateUI();
  loadRanking();
}
init();

/* ========= UI ========= */
function updateUI(){
  document.getElementById("stage").textContent=`Stage ${stage}`;
  document.getElementById("moves").textContent=`Moves: ${movesLeft}`;
  document.getElementById("goal").textContent=
    Object.entries(goal).map(([k,v])=>`${k}:${Math.max(0,v)}`).join(" ");
  document.getElementById("score").textContent=`Score: ${score}`;
}

/* ========= ÊèèÁîª ========= */
function draw(){
  const g=document.getElementById("grid");
  g.style.gridTemplateColumns=`repeat(${COLS},1fr)`;
  g.innerHTML="";
  board.forEach((row,r)=>{
    row.forEach((cell,c)=>{
      const d=document.createElement("div");
      if(!cell) return g.appendChild(document.createElement("div"));
      d.className="cell "+(cell.type==="color"?cell.value:cell.type);
      d.textContent=cell.type==="rocket"?"üöÄ":cell.type==="bomb"?"üí£":"";
      d.onclick=()=>tap(r,c);
      g.appendChild(d);
    });
  });
}

/* ========= „Çø„ÉÉ„Éó ========= */
function tap(r,c){
  if(movesLeft<=0) return;
  const cell=board[r][c];
  if(!cell) return;

  if(cell.type!=="color"){
    activate(r,c,cell.type);
    useMove();
    return;
  }

  const group=[];
  flood(r,c,cell.value,group,{});
  if(group.length<2) return;

  let special=null;
  if(group.length>=6) special="bomb";
  else if(group.length>=4) special="rocket";

  group.forEach(([x,y])=>{
    goal[board[x][y].value]--;
    board[x][y]=null;
    score+=10;
  });

  if(special){
    const [x,y]=group[0];
    board[x][y]={type:special};
  }

  animateClear(group,()=>{
    collapse(); refill(); useMove();
  });
}

/* ========= „Éï„É©„ÉÉ„Éâ ========= */
function flood(r,c,color,group,seen){
  const k=r+","+c;
  if(seen[k]||r<0||c<0||r>=ROWS||c>=COLS) return;
  const cell=board[r][c];
  if(!cell||cell.type!=="color"||cell.value!==color) return;
  seen[k]=1; group.push([r,c]);
  flood(r+1,c,color,group,seen);
  flood(r-1,c,color,group,seen);
  flood(r,c+1,color,group,seen);
  flood(r,c-1,color,group,seen);
}

/* ========= ÁâπÊÆä ========= */
function activate(r,c,type){
  const cells=[];
  if(type==="rocket"){
    for(let i=0;i<COLS;i++) cells.push([r,i]);
    for(let i=0;i<ROWS;i++) cells.push([i,c]);
  }
  if(type==="bomb"){
    for(let dr=-2;dr<=2;dr++)
      for(let dc=-2;dc<=2;dc++){
        const nr=r+dr,nc=c+dc;
        if(nr>=0&&nc>=0&&nr<ROWS&&nc<COLS) cells.push([nr,nc]);
      }
  }
  cells.forEach(([x,y])=>board[x][y]=null);
  animateClear(cells,()=>{
    collapse(); refill();
  });
}

/* ========= „Ç¢„Éã„É° ========= */
function animateClear(cells,cb){
  const els=[...document.querySelectorAll(".cell")];
  cells.forEach(([r,c])=>{
    const i=r*COLS+c;
    if(els[i]) els[i].classList.add("fade");
  });
  setTimeout(cb,400);
}

/* ========= ËêΩ‰∏ã & Ë£úÂÖÖ ========= */
function collapse(){
  for(let c=0;c<COLS;c++){
    let stack=[];
    for(let r=ROWS-1;r>=0;r--) if(board[r][c]) stack.push(board[r][c]);
    for(let r=ROWS-1;r>=0;r--) board[r][c]=stack.shift()||null;
  }
}
function refill(){
  for(let r=0;r<ROWS;r++)
    for(let c=0;c<COLS;c++)
      if(!board[r][c])
        board[r][c]={type:"color",value:randColor(5)};
  draw();
}

/* ========= ÈÄ≤Ë°å ========= */
function useMove(){
  movesLeft--;
  updateUI();
  if(Object.values(goal).every(v=>v<=0)){
    stage++;
    localStorage.setItem("blastStage",stage);
    setTimeout(init,700);
  }
}

/* ========= „É©„É≥„Ç≠„É≥„Ç∞ ========= */
function sendScore(){
  const name=document.getElementById("nameInput").value;
  if(!name) return alert("ÂêçÂâç„ÇíÂÖ•„Çå„Å¶„Å≠");
  const list=JSON.parse(localStorage.getItem("blastRank")||"[]");
  list.push({name,score});
  list.sort((a,b)=>b.score-a.score);
  localStorage.setItem("blastRank",JSON.stringify(list.slice(0,10)));
  loadRanking();
}

function loadRanking(){
  const r=document.getElementById("ranking");
  r.innerHTML="";
  (JSON.parse(localStorage.getItem("blastRank")||"[]")).forEach(e=>{
    const li=document.createElement("li");
    li.textContent=`${e.name} - ${e.score}`;
    r.appendChild(li);
  });
}
</script>
</body>
</html>
