<script>
const FADE_TIME = 600; // â† CSSã¨åˆã‚ã›ã‚‹

function markFade(list){
  list.forEach(([r,c])=>{
    if(board[r][c]){
      board[r][c].fade = true;
    }
  });
  draw();
}

function removeAfterFade(list){
  setTimeout(()=>{
    list.forEach(([r,c])=>{
      board[r][c] = null;
    });
    collapse();
    refill();
  }, FADE_TIME);
}

function activate(r,c,type,combo){
  let targets = [[r,c]];
  const bomb = combo.bomb || 0;
  const rocket = combo.rocket || 0;

  // ðŸš€ ãƒ­ã‚±ãƒƒãƒˆå‡¦ç†
  if(type==="rocket"){
    const span = (rocket>=2 || combo.bomb)?2:1;
    for(let d=-(span-1); d<=span-1; d++){
      if(r+d>=0 && r+d<ROWS)
        for(let i=0;i<COLS;i++) targets.push([r+d,i]);
      if(c+d>=0 && c+d<COLS)
        for(let i=0;i<ROWS;i++) targets.push([i,c+d]);
    }
  }

  // ðŸ’£ çˆ†å¼¾å‡¦ç†
  if(type==="bomb"){
    const range = bomb>=2 ? 3 : 2;
    for(let dr=-range;dr<=range;dr++)
      for(let dc=-range;dc<=range;dc++){
        const nr=r+dr,nc=c+dc;
        if(nr>=0&&nc>=0&&nr<ROWS&&nc<COLS)
          targets.push([nr,nc]);
      }
  }

  // ðŸŽ¬ ã‚†ã£ãã‚Šæ¶ˆã™
  markFade(targets);
  removeAfterFade(targets);
}

function tap(r,c){
  if(movesLeft<=0||!board[r][c]) return;
  const cell=board[r][c];

  if(cell.type!=="color"){
    activate(r,c,cell.type,{[cell.type]:1});
    endMove();
    return;
  }

  const group=[];
  flood(r,c,cell.value,group,{});
  if(group.length<2) return;

  let special=null;
  if(group.length>=6) special="bomb";
  else if(group.length>=4) special="rocket";

  group.forEach(([x,y])=>{
    if(goal[board[x][y].value]>0) goal[board[x][y].value]--;
  });

  markFade(group);

  setTimeout(()=>{
    group.forEach(([x,y])=>board[x][y]=null);
    if(special){
      const [x,y]=group[0];
      board[x][y]={type:special};
    }
    collapse();
    refill();
  },FADE_TIME);

  endMove();
}
</script>
